<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="zjw&#39;s blog">
<meta property="og:url" content="http://paulzjw.github.io/index.html">
<meta property="og:site_name" content="zjw&#39;s blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="zjw&#39;s blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://paulzjw.github.io/">





  <title>zjw's blog</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zjw's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://paulzjw.github.io/2019/10/29/consul-and-nginx/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zjw">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zjw's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/29/consul-and-nginx/" itemprop="url">consul-and-nginx</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-29T19:25:29+08:00">
                2019-10-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="使用 consul 实现 nginx 动态负载均衡"><a href="# 使用 consul 实现 nginx 动态负载均衡" class="headerlink" title="使用 consul 实现 nginx 动态负载均衡"></a>使用 consul 实现 nginx 动态负载均衡</h1><h2 id="consul 简介"><a href="#consul 简介" class="headerlink" title="consul 简介"></a>consul 简介</h2><p>consul 是一个 service mesh 解决方案，主要提供服务发现、健康检查、KV 存储、数据中心等功能。</p>
<h2 id="安装 consul"><a href="# 安装 consul" class="headerlink" title="安装 consul"></a>安装 consul</h2><p>consul 使用 go 语言实现，只需要到官网 <a href="https://www.consul.io/downloads.html" target="_blank" rel="noopener">https://www.consul.io/downloads.html</a> 下载对应平台的二进制文件即可。 linux 和 windows 平台均可以放在环境变量已有路径或者另外配置环境变量。</p>
<h2 id="运行 -agent"><a href="# 运行 -agent" class="headerlink" title="运行 agent"></a>运行 agent</h2><p>consul 完成安装后，需要运行 agent 。 agent 可以分为 server 和 client 模式，每个数据中心至少必须有一台 server ，建议一个集群里有 3 到 5 个 server ，部署单一的 server，在出现失败时会不可避免的造成数据丢失。</p>
<h2 id="consul- 架构"><a href="#consul- 架构" class="headerlink" title="consul 架构"></a>consul 架构</h2><p>consul 官方架构图如图所示:<br><img src="https://raw.githubusercontent.com/paulzjw/paulzjw.github.io/src/source/_posts/2019-10-29-consul-and-nginx/consul-arch.png" alt="consul-arch"></p>
<p>图中包含了 consul 多数据中心的设计，本次只讲上面单数据中心的情况。consul 推荐 3-5 台 server 做集群，其他节点和 server 通信通过 client 代理。</p>
<p>consul client 设计为 sidecar 模式。使用 client 代理的好处，所有操作都只用对本机 client 进程操作，读操作 (如服务发现、kv 读) 减轻 consul 集群压力，写操作 (如服务注册、kv 写等) 由 client 代理通过 rpc 转发到 consul 集群，解耦一些业务不相关的操作，如建康检查等。</p>
<h2 id="consul 配合 nginx 使用实现动态负载均衡"><a href="#consul 配合 nginx 使用实现动态负载均衡" class="headerlink" title="consul 配合 nginx 使用实现动态负载均衡"></a>consul 配合 nginx 使用实现动态负载均衡 </h2><h3 id="只使用 nginx 做负载均衡"><a href="# 只使用 nginx 做负载均衡" class="headerlink" title="只使用 nginx 做负载均衡"></a> 只使用 nginx 做负载均衡 </h3><p> 一般只使用 nginx 做负载均衡的设计如下图所示：<br><img src="https://raw.githubusercontent.com/paulzjw/paulzjw.github.io/src/source/_posts/2019-10-29-consul-and-nginx/Snipaste_2019-11-01_15-50-58.jpg" alt="consul-arch"></p>
<p>nginx 单独部署，然后将请求负载均衡到对应服务器上的具体业务服务。<br>这样做的好处是使用了 nginx 带来的好处，缺点是 nginx 负载均衡只支持静态配置文件，业务服务下线或者上线，需要手动修改配置文件重启 nginx 生效。</p>
<h3 id="consul 配合 nginx 使用"><a href="#consul 配合 nginx 使用" class="headerlink" title="consul 配合 nginx 使用"></a>consul 配合 nginx 使用 </h3><p> 使用 conusl 做为注册中心，可以将设计改为如下图所示：<br><img src="https://raw.githubusercontent.com/paulzjw/paulzjw.github.io/src/source/_posts/2019-10-29-consul-and-nginx/Snipaste_2019-11-01_16-12-17.jpg" alt="consul-arch"></p>
<p>所有微服务的服务注册和服务发现由 consul 集群管理，微服务只需要实现 / 调用服务注册，服务发现和建康检查 3 个 http 接口，在服务启动时将服务注册请求到本机 consul client 即可。</p>
<p>我们将 nginx 的 upstream 配置使用 consul-template 写出模板文件，然后启动 consul-template 进程监听。当有微服务下线或者上线新的微服务，consul-template 能根据模板文件更新 nginx 配置文件，并执行自定义命令(重启 nginx)，这样就完成了微服务上下线 / 维护 / 扩容时，nginx 负载均衡做动态更新。</p>
<p>consul 集群的高可用需要部署 3-5 台 consul server，多了影响网络性能，小于 3 台则 consul server 不能出现单机故障。</p>
<p>nginx 所在机子的高可用可以使用 keepalived，主从配置，从机可同主机配置和启动方式一样，这样微服务在线状态更新时，从机的 nginx 配置也是最新的，如果主机故障了，从机可以顺利切换。</p>
<p>微服务的高可用理论上(单机能够满足业务 qps 的情况）只需相同的微服务部署大于 1 台机子即可，这样一台机子故障了，请求还能负载均衡到另一台上继续业务。</p>
<p>讲了使用 consul, consul-template,nginx 配合进行动态负载均衡的情况，也总结一下缺点：</p>
<p>1. 如果网络情况不好的情况，可能会出现具体业务微服务频繁上下线导致频繁更新 nginx 配置，nginx 频繁重启。这点可以考虑适当加大心跳时间来避免偶尔网络状况带来的心跳检测问题，或者将 consul-template 配置成定时同步(配置会更新不实时，但是如果大量上下线微服务可以只用更新一次配置，重启一次)。</p>
<p>2.nginx 重启多少会对性能带来一些影响，nginx reload 机制保证已经接收请求的进程在处理完请求再退出，但是不满足 http keepalive。<br>consul 支持 dns 查询，nginx 也支持配置 dns，可以考虑使用 nginx dns 查询代替 consul-template，这样不需要更新 nginx 配置和重启 nginx。但是原生 nginx 不支持 dns srv，所以如果出现一台机子上部署相同微服务使用不同端口，nginx dns 查询方式就不能正确支持并负载均衡了。</p>
<h2 id="consul- 集群部署"><a href="#consul- 集群部署" class="headerlink" title="consul 集群部署"></a>consul 集群部署</h2><h3 id="consul-server 单节点启动命令示例"><a href="#consul-server 单节点启动命令示例" class="headerlink" title="consul server 单节点启动命令示例"></a>consul server 单节点启动命令示例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul agent -<span class="built_in">bind</span>=ip -server=<span class="literal">true</span> -bootstrap -client=0.0.0.0 -ui -data-dir=/path/to/data -config-dir=/path/to/config -datacenter=datacenter_name -node=node_name</span><br></pre></td></tr></table></figure>
<p><code>-bind</code>在多网卡时需要使用，多网卡时，consul 不清楚绑定哪个网卡，需要指定 ip，单网卡时可以不填。</p>
<p><code>-sever</code>模式表示 consul agent 以 client 还是 server 模式启动，默认为 server 模式，以 client 模式启动需修改为 -server=false,</p>
<p><code>-bootstrap</code>表示以 bootstrap 模式启动，单节点时必填，不然会因为没有 leader 无法正常启动，同命令 <code>-bootstrap-expect</code> 互斥，后续部署集群再继续讲。</p>
<p><code>-client</code> 配置 ip 表示可以访问 consul http api 这个 server 监听的 ip，如果为 127.0.0.1 只能本机访问。</p>
<p><code>-ui</code>表示启动 consul 默认 web 界面。-data-dir 为 consul 保存节点信息的路径，必填。</p>
<p><code>-config-dir</code>为 consul 配置文件信息路径，可填可不填，在配置文件路径里的 json 文件。</p>
<p><code>-datacenter</code>指定数据中心名称，不填默认 dc1, 同一数据中心下的名称要求一定相同。</p>
<p><code>-node</code>表示节点名称，不填默认 pc 的名称，建议按照一定格式规范节点名</p>
<p>更多命令参数和解释可以参考官网:<a href="https://www.consul.io/docs/agent/options.html#command-line-options" target="_blank" rel="noopener">https://www.consul.io/docs/agent/options.html#command-line-options</a></p>
<h3 id="consul- 集群部署命令示例"><a href="#consul- 集群部署命令示例" class="headerlink" title="consul 集群部署命令示例"></a>consul 集群部署命令示例 </h3><p>consul 可以以两种方式启动集群，一种是指定 leader 启动，先启动一个 leader，再依次启动剩下节点，然后执行命令 <code>consul join leader ip</code>。leader 启动命令同上，带上<code>-bootstrap</code> 参数。</p>
<p>另一种启动方式为不指定 leader 启动三个节点，启动命令同上，<code>-bootstrap</code>替换为<code>-bootstrap-expecp=3</code>，三个节点都启动完后因为没有 leader 和不知道彼此，集群还不能使用，在三个节点依次执行命令<code>consul join ip1 ip2 ip3</code> 三台机子都执行完后，会进行选举，然后集群可以使用。</p>
<p>判断集群是否可以使用可以登录 consul 自带的 web 页面，若报错则表示未正常运行，web 页面默认是 8500 端口，如图所示为一个三节点集群，leader 为五角星标志的机子：<img src="https://raw.githubusercontent.com/paulzjw/paulzjw.github.io/src/source/_posts/2019-10-29-consul-and-nginx/Snipaste_2019-11-04_19-19-28.jpg" alt="cluster.jpg"></p>
<h2 id="consul-client 启动"><a href="#consul-client 启动" class="headerlink" title="consul client 启动"></a>consul client 启动</h2><p>consul client 启动命令同 consul server 大致相同，区别 -server=false 必须为 false，不能使用 -bootstrap 或者 -bootstrap-expect 参数，其他同 server 启动命令一致。<br>consul client 加入器群节点也很简单，可以在启动时加入 -join=consul server 中其中一台的 ip，也可先启动，再执行命令<code>consul join server ip</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul agent -<span class="built_in">bind</span>=ip -server=<span class="literal">false</span> -client=0.0.0.0 -ui -data-dir=/path/to/data -config-dir=/path/to/config -datacenter=datacenter_name -node=node_name -join=ip</span><br></pre></td></tr></table></figure>
<p>或者不带上<code>-join</code>，启动完后执行<code>consul join ip</code></p>
<p>consul client 不可脱离 consul server 运行，至少要有一个 consul server 节点，且 client 要 join server 节点才可使用</p>
<h2 id="consul-tempalte 使用"><a href="#consul-tempalte 使用" class="headerlink" title="consul-tempalte 使用"></a>consul-tempalte 使用 </h2><h3 id="安装 conusl-template"><a href="# 安装 conusl-template" class="headerlink" title="安装 conusl-template"></a> 安装 conusl-template</h3><p>到官网 <a href="https://releases.hashicorp.com/consul-template" target="_blank" rel="noopener">https://releases.hashicorp.com/consul-template</a> 下载对应平台的二进制文件即可，部署方式同 consul。</p>
<h3 id="编写 consul-template 模板"><a href="# 编写 consul-template 模板" class="headerlink" title="编写 consul-template 模板"></a>编写 consul-template 模板</h3>
undefined


<p>示例为一个 upstream.tpl 文件，<code>range service &quot;web&quot;</code>和 <code>end</code> 类似 for 循环， <code>web</code>表示服务发现名称为 web 的服务，ip 和端口不做解释。</p>
<p>nginx.conf 里 include 这部分模板生成的对应文件, 如图所示：<img src="https://raw.githubusercontent.com/paulzjw/paulzjw.github.io/src/source/_posts/2019-10-29-consul-and-nginx/Snipaste_2019-11-04_19-54-23.jpg" alt="config"></p>
<h3 id="启动 consul-template"><a href="# 启动 consul-template" class="headerlink" title="启动 consul-template"></a>启动 consul-template</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul-template -consul-addr 127.0.0.1:8500 -template <span class="string">"./upstream.tpl:./conf/upstream.conf:nginx -s reload"</span></span><br></pre></td></tr></table></figure>
<p>如上所示为一个 consul-template 监控集群微服务上下线状况后并更新相应 nginx 配置的启动命令。</p>
<p><code>-consul-addr</code>指定 consul client/server 的 ip 和 http 端口，此处我们还是使用 consul 推荐的连本机 client 的方式，所以 ip 是 127.0.0.1，端口默认是 8500。consul 不限制 server 可以被使用，也可以将 ip 配置成 consul 集群的里其中一个 consul server 的 ip，推荐还是使用当前方式，即 consul 推荐的方式。</p>
<p><code>-template</code>表示执行的模板命令,upstream.tpl 为之前编写的 consul-template 模板文件的具体路径，upstream.conf 为生成的配置文件，同上面截图 <code>include upstream.conf</code> 相对应，<code>nginx -s reload</code>生成完配置文件后重启 nignx，也可以自定义别的命令。<br>这样当有服务在线状态变化，upstream.conf 文件会自动生成，并重启 nginx 动态更新 nginx 的负载均衡。</p>
<p>更多命令和用法参考官网:<a href="https://github.com/hashicorp/consul-template#command-line-flags" target="_blank" rel="noopener">https://github.com/hashicorp/consul-template#command-line-flags</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://paulzjw.github.io/2018/11/08/generate-function-calling-graph/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zjw">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zjw's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/08/generate-function-calling-graph/" itemprop="url">generate function calling graph</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-08T23:13:17+08:00">
                2018-11-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="生成函数调用图"><a href="# 生成函数调用图" class="headerlink" title="生成函数调用图"></a>生成函数调用图 </h1><p> 目的: 记录 ubnutu 下 doxygen 和 graphviz 生成函数调用关系图</p>
<h2 id="安装 graphviz"><a href="# 安装 graphviz" class="headerlink" title="安装 graphviz"></a>安装 graphviz</h2><p>命令行输入<code>sudo apt-get install graphviz</code></p>
<h2 id="安装 doxygen"><a href="# 安装 doxygen" class="headerlink" title="安装 doxygen"></a>安装 doxygen</h2><p>进入 doxygen 官网 <a href="http://www.stack.nl/~dimitri/doxygen/download.html" target="_blank" rel="noopener"> 下载页面 </a><br> 按照提示 git clone 源码<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/doxygen/doxygen.git</span><br><span class="line">cd doxygen</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake -G "Unix Makefiles" ..</span><br><span class="line">make</span><br></pre></td></tr></table></figure></p>
<p>在 cmake 这一步出了问题, 报错 <code>Could NOT find FLEX (missing: FLEX_EXECUTABLE)</code><br>网上搜索一番, 需要安装 flex 和 bison<br>命令行输入 <code>sudo apt-get install flex bison</code> 解决</p>
<ul>
<li>据悉,doxygen 安装可以使用命令行 <code>sudo apt-get install doxygen</code> 一键完成</li>
</ul>
<p>至此需要的工具已经全部安装完成</p>
<h2 id="生成函数调用图 -1"><a href="# 生成函数调用图 -1" class="headerlink" title="生成函数调用图"></a>生成函数调用图 </h2><p>1. 下载代码<br> 因为想学习 redis 源码, 本次以 redis 的源码为例, 首先搜索个版本最低的 redis, 路径为 <a href="https://code.google.com/archive/p/redis/downloads?page=7" target="_blank" rel="noopener">https://code.google.com/archive/p/redis/downloads?page=7</a> 我们选择<a href="https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/redis/redis-beta-1.tar.gz" target="_blank" rel="noopener">redis-beta-1.tar.gz</a> 作为入门代码, 下载完成后解压</p>
<p>2. 生成 doxygen 文件 Doxyfile<br><code>doxygen -g</code>生成带有注释的配置文件,<code>doxygen -s -g</code>生成不带注释的文件, 生成文件文件名 Doxyfile</p>
<p>3. 修改 Doxyfile<br>略</p>
<p>4. 生成 <br> 命令行输入<code>doxygen Doxyfile</code></p>
<p>5. 查看 <br> 本人相对来说喜欢 html 格式, 因为可以本地查看, 或者搭建 httpserver 作为静态资源当 doc, 应该也可以部署到 github pages 上. 展示其中的 main 函数调用, 效果图如下:<img src="https://s1.ax1x.com/2018/11/09/iH5yWj.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://paulzjw.github.io/2018/11/07/hexo2/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zjw">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zjw's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/07/hexo2/" itemprop="url">hexo2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-07T23:47:34+08:00">
                2018-11-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="hexo 部署源文件到 github"><a href="#hexo 部署源文件到 github" class="headerlink" title="hexo 部署源文件到 github"></a>hexo 部署源文件到 github</h2><p>在使用 hexo 部署的过程中, 会碰到一个问题, hexo 部署不会上传源文件, 只上传生成的静态文件, 这会导致无法在别的机子上继续同步博客. 在查阅了较多解决方案后, 整理了一个相对简单的方案.</p>
<ul>
<li>hexo 的部署插件 (<a href="https://github.com/hexojs/hexo-deployer-git" target="_blank" rel="noopener">hexo-deployer-git</a>) 本身支持多地, 多仓库更新, 首先修改配置文件_config.yml</li>
<li><p>修改 deploy 配置项为:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  - type:</span> <span class="string">git</span></span><br><span class="line"><span class="attr">    repo:</span> <span class="string">git@github.com:&lt;username&gt;/&lt;username&gt;.github.io.git</span></span><br><span class="line"><span class="attr">    branch:</span> <span class="string">master</span></span><br><span class="line"><span class="attr">  - type:</span> <span class="string">git</span></span><br><span class="line"><span class="attr">    repo:</span> <span class="string">git@github.com:&lt;username&gt;/&lt;username&gt;.github.io.git</span></span><br><span class="line"><span class="attr">    branch:</span> <span class="string">src</span></span><br><span class="line"><span class="attr">    extend_dirs:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">    ignore_hidden:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    ignore_pattern:</span></span><br><span class="line"><span class="attr">        public:</span> <span class="string">.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>此时使用命令部署, 会在 github 里创建 src 分支, 并将源文件和配置文件上传</p>
</li>
<li><p>登录 github, 设置 &lt;username>.github.io.git 仓库, 选择默认分支为 src, 如图所示:<br><img src="https://s1.ax1x.com/2018/11/08/i7t6pR.png" alt=""></p>
</li>
<li><p>设置默认分支为 src 之后, 每次部署时, 会自动向 github 上传两个分支对应的文件, 其他环境更新博客, 只需要 git clone 后 npm install 即可</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://paulzjw.github.io/2018/11/06/hexo1/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zjw">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zjw's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/06/hexo1/" itemprop="url">hexo1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-11-06T21:22:44+08:00">
                2018-11-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="使用 github-pages 和 hexo 搭建 blog"><a href="# 使用 github-pages 和 hexo 搭建 blog" class="headerlink" title="使用 github pages 和 hexo 搭建 blog"></a>使用 github pages 和 hexo 搭建 blog</h2><ul>
<li><p>使用 npm 安装:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> npm install -g hexo-cli</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 hexo 文件夹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> hexo init &lt;dir&gt;</span><br><span class="line"><span class="meta">$</span> cd &lt;dir&gt;</span><br><span class="line"><span class="meta">$</span> npm install</span><br></pre></td></tr></table></figure>
</li>
<li><p>hexo 生成:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> hex g</span><br></pre></td></tr></table></figure>
</li>
<li><p>hexo 部署:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> hexo d</span><br><span class="line"><span class="meta">$</span> hexo d -g #(和生成一起)</span><br></pre></td></tr></table></figure>
</li>
<li><p>hexo 添加 readme.md:<br>在 根目录 /source 文件夹新建 README.md 文件 <br> 修改 _config.yml 配置文件, skip_render 项, 添加 README.md</p>
</li>
</ul>
<p>更多 hexo 相关内容可参照<a href="https://hexo.io" target="_blank" rel="noopener">hexo 官方文档</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zjw</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zjw</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
